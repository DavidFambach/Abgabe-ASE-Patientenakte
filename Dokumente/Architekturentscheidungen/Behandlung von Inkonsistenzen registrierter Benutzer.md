# Architekturentscheidung: Behandlung von Inkonsistenzen registrierter Benutzer

## Zusammenfassung
Bereich: Datenkonsistenz
Thema: Inkonsistenzen im Benutzerdatensatz durch Synchronisationsfehler zwischen Diensten
ID: AD8
Architekturentscheidung: Dienste, die eine Kopie der Benutzerdaten vorhalten, gleichen diese regelmäßig mit der Quelle ab

|                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ------------------------- |------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Problemstellung           | Das Verfahren zur Benachrichtigungen von Diensten, die ein Lesemodell der Benutzerdaten vorhalten, über Änderungen dieser Daten ist fehleranfällig, sodass Inkonsistenzen zwischen dem Lesemodell und der Datenquelle auftreten können (vgl. Konzept "Konsistenz von Benutzerdaten"). Damit die Kopien auch in diesen Fällen schließliche Konsistenz erreichen, ist ein Korrekturverfahren erforderlich. Es ist auszuwählen, wie mit Inkonsistenzen umgegangen wird.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| Annahmen                  | - Es existieren mehrere Dienste mit eigenen Datenbanken, über die hinweg Benutzerdaten synchronisiert werden müssen<br>- Die Information über die Löschung eines Benutzers wird über eine Event-Queue bereitgestellt<br>- Die versendeten Nachrichten können in Fehlersituationen verloren gehen, insbesondere wenn die Nachricht aufgrund eines Fehler nicht abgesendet werden kann oder wenn die Verarbeitung einer Nachricht zu einem Fehler führt                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| Motivation                | Erreichen eines ausreichenden Konsistenzniveaus                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| Alternativen              | Inkonsistenz akzeptieren<br>Regelmäßiger Abgleich durch Lesemodelle an der Datenquelle<br>Sichere Wiederholung fehlschlagender Operationen (SAGA)<br>Regelmäßiges versenden gültiger Benutzer über die Event-Queue                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Entscheidung              | Verwende regelmäßigen Abgleich durch Lesemodelle an der Datenquelle                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Begründung                | Schließliche Konsistenz sollte für die Benutzerdaten erreicht werden, weil ansonsten die garantierte Löschung von Benutzerdaten manuelle Eingriffe in das System erfordert. Ein regelmäßiger Abgleich des Datenverwenders mit der Quelle, ein regelmäßiges Aussenden des aktuellen Datenstandes durch die Quelle oder die sichere Widerholung fehlgeschlagener Operationen erreichen schließliche Konsistenz. Eine sichere Wiederholung erfordert eine zusätzliche Anwendungskomponente die erneute Versuche auslöst plus gegebenenfalls explizite Zurückrolloperationen durch Dienste. Davon wird aufgrund des deutlich höhren Aufwands abgesehen. Das wiederholte Anfragen von Daten durch den Verwender wird über ein wiederholtes Aussenden der Quelle gestellt, weil die Vorteile der letzteren Variante bei einer größeren Anzahl Verwender zum Tragen kommt, aber zur Zeit nur ein Dienst vorgesehen ist. Weitere Überlegunen und teilweise Ausführungen zu den Anmerkungen in der Entscheidungsmatrik sind im Konzept "Konsistenz von Benutzerdaten" aufgeführt. |
| Implikationen             | - Die Datenquelle muss eine Abfrageschnittstelle für die Überprüfung der Daten bereitstellen<br>- Die Datenverwender müssen selbstständig wiederholt Anfragen an die Quelle stellen<br>- Kommen viele Dienste hinzu, kann es zu einer Überlastung der Datenquelle durch viele Anfragen zu denselben Daten kommen                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Abgeleitete Anforderungen | Keine                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| Zugehörige Entscheidungen | Keine                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |

## Entscheidungsmatrix
| Kriterien                             | Gewichtung | Inkonsistenz akzeptieren                                      | Evaluierung | Regelmäßiger Abgleich durch Lesemodelle an der Datenquelle    | Evaluierung | Sichere Wiederholung fehlschlagender Operationen (SAGA)       | Evaluierung | Regelmäßiges versenden gültiger Benutzer über die Event-Queue | Evaluierung |
| ------------------------------------- | ---------- | ------------------------------------------------------------- | ----------- | ------------------------------------------------------------- | ----------- | ------------------------------------------------------------- | ----------- | ------------------------------------------------------------- | ----------- |
| Implementierungsaufwand               | 2          | Keiner                                                        | ++          | Anpassungen an Datenquelle und -verwender erforderlich        | O           | SAGA-Orchestrator erforderlich                                | -           | Auslöser für die Aussendung erforderlich                      | +           |
| Ressourcenaufwand zur Synchronisation | 2          | Keiner                                                        | ++          | wächst mit Benuzerzahl, kann aber etappenweise erfolgen       | +           | SAGA-Orchestrator erforderlich                                | -           | viele nicht angeforderte Nachrichten; besser ja mehr Dienste  | -           |
| Notwendigkeit manueller Eingriffe     | 5          | Manuelle Eingriffe z. B. bei DSGVO-Anfragen notwendig         | --          | Keiner, schließliche Konsistenz ist garantiert                | ++          | Keiner, schließliche Konsistenz ist garantiert                | ++          | Keiner, schließliche Konsistenz ist garantiert                | ++          |
| Stärke der Konsistenzgarantie         | 3          | Inkonsistenzen sind möglich                                   | --          | garantiert schließliche, aber keine starke Konsistenz         | +           | garantiert schließliche, aber keine starke Konsistenz         | +           | garantiert schließliche, aber keine starke Konsistenz         | +           |
| Größe des Inkonsistenzfenzters        | 1          | Unendlich                                                     | --          | abhängig von Intervall, Etappengröße und Benutzerzahl         | O           | abhängig von der Anzahl notwendiger Wiederholungen            | +           | abhängig von Intervall, Etappengröße und Benutzerzahl         | O           |
| **Gesamt**                            |            |                                                               | -15 Pkt.    |                                                               | 20 Pkt.     |                                                               | 15 Pkt.     |                                                               | 18 Pkt.     |

Legende zur Evaluierung:
 - ++: Die Alternative ist bezüglich dem Kriterium sehr positiv zu bewerten. Diese Bewertung entspricht 3 Punkten.
 - +: Die Alternative ist bezüglich dem Kriterium positiv zu bewerten. Diese Bewertung entspricht 1 Punkt.
 - O: Die Alternative ist bezüglich dem Kriterium neutral zu bewerten, eine Bewertung der Alternative hinsichtlich dieses Kriteriums ist nicht sinnvoll oder nicht praktikabel oder wurde aus einem anderen Grund nicht vorgenommen. Diese Bewertung entspricht 0 Punkten.
 - \-: Die Alternative ist bezüglich dem Kriterium negativ zu bewerten. Diese Bewertung entspricht -1 Punkt.
 - \-\-: Die Alternative ist bezüglich dem Kriterium sehr negativ zu bewerten. Diese Bewertung entspricht -3 Punkten.
Die Gesamtbewertung ist die Summe der gewichteten Evaluierungen über alle Kriterien, die keine Ausschlusskriterien sind. Alternativen, die bezüglich mindestens einem Ausschlusskriterium negativ bewertet wurden, erhalten keine Gesamtbewertung und werden nicht weiter betrachet.
